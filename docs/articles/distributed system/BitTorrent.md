# Bittorrent
BitTorrent is a content distribution protocol created by American programmer Bram Cohen, who is also known as the designer of the popular gaming platform Steam. BitTorrent employs content distribution and peer-to-peer technology to facilitate efficient sharing of large files among users, reducing the load on centralized servers. In the BitTorrent network, each user serves as both a downloader and an uploader of data simultaneously. The file owner sends the file to one or multiple users, who then distribute it to other users, collectively forwarding their respective portions of the file until every user has completed the download. This method helps alleviate the load on download servers, as each downloader becomes an uploader, effectively sharing the bandwidth resources and significantly increasing the average download speed of the file.

Terms:
- **Torrent:** It is the metadata file (typically ending with .torrent) that the server receives. This file contains information about the downloaded data, such as the file name, file size, file hash value, and the URL address of the tracker.
- **Tracker:** It refers to the server on the internet that coordinates the actions of BitTorrent clients. When you open a torrent, your machine connects to the tracker and requests a list of peers that you can connect to. During the transfer, the client periodically submits its status to the tracker. The tracker's role is solely to facilitate the connection between peers and does not participate in the actual file transfer.
- **Peer:** A peer is another computer on the internet that can connect and exchange data. Typically, peers do not have the complete file. Peers download and upload data to each other.
- **Seed:** A computer that possesses a complete copy of a specific torrent is called a seed. Seeds are needed for initial sharing when a file is first released.
- **Swarm:** It refers to the group of all devices connected to a torrent.
- **Choking:** Choking is a temporary strategy to deny upload connections while allowing download connections to continue. In the BitTorrent network, downloading requires peers to upload to each other, and temporary blocking is applied to uncooperative peers.
- **Pareto Efficiency:** Pareto efficiency refers to the allocation of resources reaching a stage where they are maximally utilized, and further improvement for one individual would result in a decrease in efficiency for others. This indicates that the system has reached an optimal state.
- **Tit-for-Tat:** It is a strategy in game theory that emphasizes reciprocating actions. It starts with cooperation and then adopts a strategy of treating others the way they are treated. In the context of BitTorrent, it means that a peer contributes the same amount of upload speed as it receives in download speed.

### Content Publish Procedure
Let's explain the process of how a new file is propagated in the BitTorrent network. To initiate the distribution, it starts with a seed performing the initial sharing. First, the seed generates a file with the extension ".torrent" that contains the following information: file name, size, and the URL of the tracker. At least one tracker and one seed are required for content distribution. The tracker stores the file information and maintains connections with the seeds, while the seed holds the actual file.

Once the seed registers with the tracker, it waits for peers in need of this torrent to upload relevant information. Using the .torrent file, peers access the tracker to obtain connection information of other peers/seeds, such as IP addresses and ports. Through simple remote communication between the tracker and peers, peers utilize the connection information to communicate with other peers/seeds and establish connections to download the file.

### Piece Exchange
As mentioned earlier, most peers do not have a complete copy of the file. To keep track of which pieces each peer has downloaded, BitTorrent divides the file into small pieces of 256KB each. Each downloader needs to provide the pieces they have to their peers. To ensure the integrity of the file during transmission, these downloaded pieces are verified using the SHA-1 algorithm. Only when a piece is validated as complete, the peer notifies other peers that it has that piece and can provide it for uploading.

### Piece Selection Algorithm
As mentioned earlier, the way BitTorrent selects the order of downloading pieces is crucial for improving overall speed and performance. It is important to avoid a situation where a piece is only backed up by a few peers, and if those peers go offline, the backups cannot be found, causing all peers to be unable to complete the download. BitTorrent provides a set of strategies for piece selection:
- Prioritize completing a single piece: If a sub-piece of a piece is requested, the entire piece is prioritized for requesting. This is done to prioritize completing a whole piece as much as possible, avoiding a scenario where every peer requests the same sub-piece but none of them complete the piece.
- Prioritize rarest pieces: When selecting a new piece, prioritize downloading the one with the fewest owners among all peers. The piece with the fewest owners is the most desired by the majority of peers. This approach reduces the risk of a peer providing uploads without anyone downloading (because everyone already has that piece) and the risk of a peer with missing pieces stopping uploads, preventing all peers from obtaining the complete file.
- Random selection for the first piece: At the beginning of the download, it is not necessary to prioritize the rarest pieces. At this stage, the downloader doesn't have any pieces to upload, so it needs to acquire a complete piece as soon as possible. The rarest pieces usually have only one owner, so they may be downloaded slower than the pieces owned by multiple peers. Therefore, the first piece is randomly selected until it is completed, and then the "prioritize rarest pieces" strategy is adopted.
- Cancel sub-piece requests at the end: Sometimes, when a slow peer requests a piece, it sends requests for sub-pieces of that piece to all its peers. Once some nodes send the requested sub-pieces, the peer sends cancel messages to other peers to cancel the requests for those sub-pieces, to avoid wasting bandwidth.
- These strategies help in efficient piece selection, ensuring better distribution of pieces and faster completion of downloads in the BitTorrent network.

### Choking Strategy
Unlike the HTTP protocol, file sharing in BitTorrent relies entirely on each peer, and therefore, each peer has an obligation to collectively improve the efficiency of sharing. For cooperative peers, they are rewarded with an equal upload rate based on the download speed they provide. For uncooperative peers, their uploads are temporarily rejected, but downloading continues.

Although choking is not within the scope of P2P protocols, it is necessary for improving performance. A good choking algorithm should utilize all available resources, provide consistent and reliable download speeds for all downloaders, and appropriately penalize peers who only download without uploading. This helps achieve Pareto efficiency, where resources are allocated optimally and ensures fairness among peers in the BitTorrent network.

**Optimistic Unchoking**

BitTorrent uses an algorithm called "Optimistic Unchoking" to determine which peers to connect with in order to achieve optimal download speed. In the BitTorrent network, each peer is typically limited to a certain number of connections, usually around 4. Since calculating the current download speed is challenging, BitTorrent employs an optimistic estimation-based approach to select peers for connections.

The principle of Optimistic Unchoking is to periodically reevaluate the download speeds of peers (usually every 10 seconds) and select one peer as the "optimistic unchoke" candidate. This peer is given priority for connection and uploading. The selection is based on an optimistic estimation that this peer might provide better download speed. By doing so, BitTorrent aims to explore the potential download speed of other peers and make better connection choices. The advantage of this algorithm is that it reduces frequent blocking and connection switching, thereby minimizing resource wastage. Additionally, by periodically recalculating download speeds and adjusting connections, BitTorrent can adapt to changing network conditions dynamically, providing a more stable and efficient download experience.

**Opposing Discrimination**

In certain situations, a peer may be blocked by all other peers. In such cases, it is evident that using the aforementioned methods, the blocked peer will continue to experience very low download speeds until the next optimistic unchoke occurs. To address this issue, if a peer has not received any pieces from a specific peer after a certain period of time, it will perceive itself as being "snubbed" by that peer and will no longer upload to that peer in return. This approach aims to reduce discrimination and ensure a fair sharing of resources among peers.

After a peer has completed its download task, it no longer uses its download speed as the sole criterion to determine which peers to upload to. Instead, it prioritizes other peers with better network conditions and faster connection speeds. This approach allows for a more efficient utilization of the upload bandwidth available to the peer.

